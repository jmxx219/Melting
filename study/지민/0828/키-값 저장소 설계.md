## 키-값 저장소 설계

- 분산 키-값 저장소: 분산 해시 테이블
    - 키-값 쌍을 여러 서버에 분산시킴
    - CAP 정리: 일관성, 가용성, 파티션 감내라는 세 가지 요구사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 정리
        - 일관성: 클라이언트는 어떤 노드에 접속했느냐에 관계없이 언제나 같은 데이터를 보게 되어야 함
        - 가용성: 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 함
        - 파티션 감내: 파티션은 두 노드 사이에 장애가 발생하였음을 의미. 파티션 감내는 네트워크에 파티션이 생기더라도 시스템은 계속 동작하여야 한다는 것
    - CAP 정리는 이들 가운데 어떤 두 가지를 충족하려면 남머지 하나는 무조건 희생되어야 한다는 것을 의미함
        - CP 시스템: 일관성과 파티션 감내 지원
        - AP 시스템: 가용성과 파티션 감내 지원
        - CA 시스템: 일관성과 가용성 지원
    - 대규모 애플리케이션의 경우, 데이터를 작은 파티션들로 분할한 다음에 서버에 저장하는데, 이때 안정 해시 기술을 사용한다.
        - 안정 해시를 이용하여 데이터 파티션을 하면 좋은 점
            - 규모 확장 자동화, 다양성
- 데이터 다중화
    - 높은 가용성과 안정성 확보를 위해 데이터를 N개 서버에 비동기적으로 다중화할 필요가 있음
        - 어떤 키를 해시 링 위에 배치한 후, 시계 방향으로 순회하면서 만나는 첫 N개 서버에 데이터 사본을 보관함
    - 가상 노드를 사용할 경우, 선택한 N개의 노드가 대응될 무리 서버의 개수보다 작아질 수 있음
        - 따라서 같은 물리 서버를 중복 선택하지 않도록 해야 함
            - 안정성을 위해 데이터 사본은 다른 센터의 서버에 보관하고, 센터들은 고속 네트워크로 연결함
    - 정족수 합의 프로토콜
        - N = 사본 개수, W = 쓰기 연산에 대한 정족수, R = 읽기 연산에 대한 정족수
        - W, R, N의 값을 정하는 것은 응답 지연과 데이터 일관성 사이의 타협점을 찾는 전형적인 과정
            - R=1, W=N: 빠른 읽기 연산에 최적화된 시스템
            - W=1, R=N: 빠른 쓰기 연산에 최적화된 시스템
            - W + R > N: 강한 일관성이 보장됨(보통 N=3, W=R=2)
            - W + R ≤ N: 강한 일관성이 보장되지 않음
    - 일관성 모델
        - 강한 일관성: 모든 읽기 연산은 가장 최근에 갱신된 결과를 반환함
        - 약한 일관성: 읽기 연산은 최근에 갱신된 결과를 반환하지 못할 수 있음
        - 최종 일관성: 갱신 결과가 결국에는 모든 사본에 반영되는 모델
    - 비일관성 해소 기법: 데이터 버저닝
        - 버저닝: 데이터를 변경할 때마다 해당 데이터의 새로운 버전을 만드는 것을 의미함(변경 불가능)
        - 벡터 시계: [서버, 버전]의 순서쌍을 데이터에 매단 것으로, 어떤 버전이 선행/후행 버전인지 아니면 다른 버전과 충돌이 있는지 판별하는데 쓰임
- 장애 처리
    - 장애 감지
        - 가십 프로토콜: 분산형 장애 감지 솔루션
            - 각 노드는 멤버십(멤버 ID, 박동 카운터) 목록을 유지하며, 주기적으로 자신의 박동 카운터를 증가시킴.
            - 각 노드는 무작위로 선정된 노드에게 주기적으로 자기 박동 카운터 목록을 보내고, 받은 노드는 목록을 최신 값으로 갱신함
            - 이때 지정된 시간으로 갱신되지 않으면 해당 멤버는 장애 상태인 것으로 간주함
    - 장애 해소